window.optimizely=window.optimizely||[];var ttcModule=function(){var log=function(){localStorage.getItem("logttc")&&console.log.apply(console,arguments)},getData=function(){var bucketedMetadata={};try{bucketedMetadata=JSON.parse(window.optimizely.get("visitor").custom.ttc.value)}catch(err){}return bucketedMetadata},findIdxByKey=function(haystack,key,value){if(!haystack||!haystack.length)return-1;for(var i=0;i<haystack.length;i++)if(haystack[i][key]===value)return i;return-1},saveTTCData=function(ttcData){var saveAttr={type:"user",attributes:{}};saveAttr.attributes.ttc=JSON.stringify(ttcData),window.optimizely.push(saveAttr)};return{listenTrack:function(listenFor,trackTo,resettable){var ttcData=getData(),trackItem={t:(new Date).getTime(),s:window.optimizely.get("session").sessionId,e:trackTo,o:!1},existingItem=findIdxByKey(ttcData[listenFor],"e",trackTo);resettable&&existingItem>-1?(ttcData[listenFor][existingItem].t=trackItem.t,ttcData[listenFor][existingItem].s=trackItem.s,log('Register listener for "'+listenFor+'"',ttcData)):existingItem<0&&(ttcData[listenFor]=(ttcData[listenFor]||[]).concat(trackItem),log('Register listener for "'+listenFor+'"',ttcData)),saveTTCData(ttcData)},checkDispatch:function(listenFor){var ttcData=getData();(ttcData[listenFor]||[]).forEach(function(item,idx,arr){if(!item.o){var timeDelta=Math.round((new Date-new Date(item.t))/1e3);log("Dispatch",item.e,timeDelta),arr[idx].o=!0,window.optimizely.push({type:"event",eventName:item.e,tags:{value:timeDelta}})}}),saveTTCData(ttcData)},debug:function(){console.log(getData())}}}();window.optimizely.push({type:"registerModule",moduleName:"ttc",module:ttcModule}),window.optimizely.push({type:"addListener",filter:{type:"analytics",name:"trackEvent"},handler:function(evt){window.optimizely.get("custom/ttc").checkDispatch(evt.data.apiName)}});